{% extends 'empty.html' %}

{% block top %}
    <div class="row wrapper border-bottom white-bg page-heading">
        <div class="col-lg-10">
            <h2>传感器实时数据查询</h2>
        </div>
    </div>
{% endblock %}

{% block center %}
    <div class="wrapper wrapper-content animated fadeInRight">
        <div class="row">
            <div class="col-md-6">
                <div class="ibox">
                    <div class="ibox-title">
                        <h5>查询参数设置</h5>
                        <div class="ibox-tools">
                            <a class="collapse-link">
                                <i class="fa fa-chevron-up"></i>
                            </a>

                            <ul class="dropdown-menu dropdown-user">

                            </ul>
                        </div>
                    </div>
                    <div class="ibox-content">
                            <div class="row">
                                <div class="col-md-6">
                                    <label class="col-form-label">传感器数据类型：</label>
                                    <select name="sensorType" class="form-control" id="id_sensorType">
                                        <option value="wendu">温度传感器</option>
                                        <option value="yingbian">应变传感器</option>
                                        <option value="xiushi">锈蚀传感器</option>
                                        <option value="naodu">挠度传感器</option>
                                    </select>
                                </div>
                                <div class="col-md-6">
                                    <label class="col-form-label">传感器位置：</label>
                                    <select name="sensorLocation" class="form-control" id="id_sensorLocation">
                                        <option value="1">监测点1</option>
                                        <option value="2">监测点2</option>
                                        <option value="3">监测点3</option>
                                        <option value="4">监测点4</option>
                                        <option value="4">监测点5</option>
                                    </select>
                                </div>
                            </div>
                            <div class="hr-line-dashed"></div>
                            <div class=" form-group row">
                                <div class="col-md-4 col-md-offset-2" >
                                    <button class="btn btn-primary btn-sm" type="button" onclick="switchOn()">查询数据</button>
                                    <button class="btn btn-white btn-sm" type="button" onclick="switchClose()">停止</button>
                                </div>
                            </div>
                    </div>
                </div>
            </div>
            <div class="col-md-6">
                <div class="ibox ">
                    <div class="ibox-title">
                        <h5>桥梁传感器位置示意图</h5>
                        <div class="ibox-tools">
                            <a class="collapse-link">
                                <i class="fa fa-chevron-up"></i>
                            </a>
                            <ul class="dropdown-menu dropdown-user">
                            </ul>
                        </div>
                    </div>
                    <div class="ibox-content text-center" id="img">
                        <img src = 'https://s3.bmp.ovh/imgs/2021/10/84ada24d116c2974.jpg' height="180"/>
                    </div>
                </div>
            </div>
        </div>
    </div>
 <div class="wrapper wrapper-content animated fadeInRight">
        <div class="row">
            <div class="col-md-12">
                <div class="ibox">
                    <div class="ibox-title">
                        <h5>实时数据显示</h5>
                    </div>
                    <div class="ibox-content">
                        <div id="minitor" style="height:400px"></div>
                        <!-- ECharts单文件引入 -->
                        <script src="/static/echarts.js"></script>
                        <script src="/static/jquery-3.2.1.js"></script>
                        <script type="text/javascript">
                            var chartDom = document.getElementById('minitor');
                            var myChart = echarts.init(chartDom);
                            var option;
                            var xmlhttp;

                            if (window.XMLHttpRequest)
                            {
                                //  IE7+, Firefox, Chrome, Opera, Safari 浏览器执行代码
                                xmlhttp=new XMLHttpRequest();
                            }
                            else
                            {
                                // IE6, IE5 浏览器执行代码
                                xmlhttp=new ActiveXObject("Microsoft.XMLHTTP");
                            }
                            function switchClose() {
                                clearInterval(window.setInte);
                                myChart.clear();
                            }

                            function switchOn() {
                                var sensorType = document.getElementById('id_sensorType').value;
                                var sensorLocation = document.getElementById('id_sensorLocation').value;
                                var params = 'sensorType='+ sensorType+'&sensorLocation='+sensorLocation;
                                var time = [];
                                var data = [];
                                for (var i = 0; i < 120; i++) {
                                      time.push("8:00:00");
                                      data.push("0");
                                    }
                                option = {
                                    tooltip: {
                                        trigger: 'axis',
                                        axisPointer: {
                                          type: 'cross'
                                        }
                                      },
                                      xAxis: {
                                        data:[]
                                      },
                                      yAxis: {

                                      },
                                    animation:false,
                                      series: [
                                        {
                                          name: '实时数据',
                                          type: 'line',
                                          data: []
                                        }
                                      ]
                                    };
                                option && myChart.setOption(option);
                                window.setInte=setInterval(function () {
                                        xmlhttp.onreadystatechange=function()
                                            {
                                                if (xmlhttp.readyState==4 && xmlhttp.status==200)
                                                {
                                                    var responseText = JSON.parse(xmlhttp.responseText);
                                                    console.log(responseText);
                                                    console.log(typeof responseText.time);
                                                    time.shift();
                                                    time.push(responseText.time.toString());
                                                    data.shift();
                                                    data.push(responseText.data.toString());
                                                    setTimeout(
                                                    myChart.setOption({
                                                        xAxis: {
                                                            data: time
                                                        },
                                                        series: [
                                                          {
                                                            data: data
                                                          }
                                                        ]
                                                      }),50)
                                                }
                                            };
                                        xmlhttp.open("get","/ihsd/dataChange?"+params,true);
                                        xmlhttp.send();
                                    }, 2000);
                                }

                        </script>
                    </div>
            </div>
        </div>
    </div>
{% endblock %}

{% block script %}
{% endblock %}
